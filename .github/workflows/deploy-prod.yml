name: Deploy Production

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

# Explicit permissions - least privilege principle
permissions:
  contents: read
  actions: read

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  # Run CI first (if triggered by push directly)
  ci:
    name: Run CI
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present || echo "‚ö†Ô∏è Linter warnings (non-blocking)"
        continue-on-error: true

      - name: Run tests
        run: npm test --if-present || echo "‚ö†Ô∏è No tests configured"
        continue-on-error: true

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: dummy
          NEXT_PUBLIC_SANITY_DATASET: production
          SANITY_API_VERSION: 2024-03-01
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          SUPABASE_SERVICE_ROLE_KEY: dummy
          NEXTAUTH_SECRET: dummy
          NEXTAUTH_URL: http://localhost:3000
          RESEND_API_KEY: dummy
          ADMIN_EMAIL: dummy@example.com
          SANITY_WRITE_TOKEN: dummy
          SANITY_REVALIDATE_SECRET: dummy

      - name: Verify build output
        run: |
          if [ -d ".next" ]; then
            echo "‚úÖ Build successful"
          else
            echo "‚ùå Build failed - .next directory not found"
            exit 1
          fi

  deploy:
    name: Deploy to Production VPS
    # Deploy if: CI job succeeded (when triggered by push) OR workflow_run succeeded (when triggered by CI workflow)
    if: |
      (github.event_name == 'push' && (needs.ci.result == 'success' || needs.ci.result == 'skipped')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    needs: [ci]
    runs-on: ubuntu-latest
    # Automatic deployment - no approval required
    # To add approval back, uncomment: environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
        env:
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.VPS_HOST }}

      - name: Redeploy on VPS
        run: |
          ssh -o StrictHostKeyChecking=accept-new "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" << 'ENDSSH'
            set -e
            cd "${{ secrets.VPS_APP_PATH }}"
            echo "üöÄ Starting production deployment from GitHub Actions..."
            echo "üì¶ Branch: main"
            echo "‚úÖ CI passed - proceeding with deployment"
            git fetch origin
            git checkout main
            git pull origin main
            echo "üî® Building and starting containers..."
            docker compose up -d --build
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 15
          ssh -o StrictHostKeyChecking=accept-new "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" << 'ENDSSH'
            cd "${{ secrets.VPS_APP_PATH }}"
            echo "üè• Checking application health..."
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Production deployment verified - application is healthy"
            else
              echo "‚ö†Ô∏è Health check failed - check logs manually"
              docker compose logs --tail=50
              exit 1
            fi
          ENDSSH

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Production deployment completed successfully"
          else
            echo "‚ùå Production deployment failed"
            exit 1
          fi
